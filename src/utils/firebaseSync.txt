// firebaseSyncService.js
import axios from 'axios'
import {
  getUserData,
  storeUserData,
  getCards,
  storeCards,
  getLastUpdate,
  setLastUpdate,
} from './indexedDBService'

const BACKEND_URL = import.meta.env.VITE_API_BASE_URL
const API_BASE = `${BACKEND_URL}/api`

// ---------------------------
// Fetch user from backend
// ---------------------------
export const fetchUserFromBackend = async (userId) => {
  try {
    const res = await axios.get(`${API_BASE}/user/${userId}`)
    return res.data
  } catch (error) {
    console.error('Error fetching user from backend:', error)
    return null
  }
}

// ---------------------------
// Upload user to backend
// ---------------------------
export const uploadUserToBackend = async (userData) => {
  try {
    const res = await axios.post(`${API_BASE}/user/${userData.userId}`, {
      userData,
    })
    return res.data
  } catch (error) {
    console.error('Error uploading user to backend:', error)
    return null
  }
}

// ---------------------------
// Fetch user cards from backend
// ---------------------------
export const fetchUserCardsFromBackend = async (userId) => {
  try {
    const res = await axios.get(`${API_BASE}/user-cards/${userId}`)
    return res.data
  } catch (error) {
    console.error('Error fetching user cards from backend:', error)
    return []
  }
}

// ---------------------------
// Upload user cards to backend
// ---------------------------
export const uploadCardsToBackend = async (userId, cards) => {
  try {
    const res = await axios.post(`${API_BASE}/user-cards/${userId}`, { cards })
    return res.data
  } catch (error) {
    console.error('Error uploading cards to backend:', error)
    return null
  }
}

// ---------------------------
// Initialize user on app start
// ---------------------------
export const initializeUser = async (userId, telegramData) => {
  try {
    // 1️⃣ Load local data
    const localUser = await getUserData()
    const localCards = (await getCards()) || []
    const localLastUpdate = (await getLastUpdate()) || 0

    // 2️⃣ Fetch backend data
    const backendUser = await fetchUserFromBackend(userId)
    const backendCards = await fetchUserCardsFromBackend(userId)

    let finalUser = null
    let finalCards = []

    // 3️⃣ Handle user existence
    if (!localUser && !backendUser) {
      // New user → create using Telegram data
      finalUser = {
        userId: userId,
        first_name: telegramData.first_name || '',
        last_name: telegramData.last_name || '',
        username: telegramData.username || '',
        photo_url: telegramData.photo_url || '',
        coins: 1000000,
        xp: 0,
        pph: 1500,
        level: 1,
        streak: 0,
        tutorialDone: false,
        registration_timestamp: new Date().toISOString(),
        lastUpdate: Date.now(),
      }
      // Save locally and backend
      await storeUserData(finalUser)
      await uploadUserToBackend(finalUser)
      finalCards = [] // No cards yet
      await storeCards(finalCards)
    } else if (!localUser && backendUser) {
      // Local missing, backend exists → take backend
      finalUser = backendUser
      finalCards = backendCards
      await storeUserData(finalUser)
      await storeCards(finalCards)
      await setLastUpdate(finalUser.lastUpdate || Date.now())
    } else if (localUser && !backendUser) {
      // Backend missing → local wins
      finalUser = { ...localUser, lastUpdate: Date.now() }
      finalCards = localCards
      await uploadUserToBackend(finalUser)
      await uploadCardsToBackend(userId, finalCards)
      await setLastUpdate(finalUser.lastUpdate)
    } else {
      // Both exist → merge based on lastUpdate
      if ((backendUser.lastUpdate || 0) > (localLastUpdate || 0)) {
        // Backend newer
        finalUser = backendUser
        finalCards = mergeCards(localCards, backendCards)
        await storeUserData(finalUser)
        await storeCards(finalCards)
        await setLastUpdate(finalUser.lastUpdate || Date.now())
      } else {
        // Local newer
        finalUser = { ...localUser, lastUpdate: Date.now() }
        finalCards = mergeCards(localCards, backendCards)
        await storeUserData(finalUser)
        await storeCards(finalCards)
        await uploadUserToBackend(finalUser)
        await uploadCardsToBackend(userId, finalCards)
        await setLastUpdate(finalUser.lastUpdate)
      }
    }

    console.log('✅ User initialization complete')
    return { user: finalUser, cards: finalCards }
  } catch (err) {
    console.error('❌ Failed to initialize user:', err)
    return null
  }
}

// ---------------------------
// Merge two card arrays (local + backend)
// ---------------------------
const mergeCards = (localCards, backendCards) => {
  const cardMap = {}
  localCards.forEach((c) => (cardMap[c.cardId] = c))
  backendCards.forEach((c) => {
    if (!cardMap[c.cardId]) cardMap[c.cardId] = c
    // If needed, add timestamp comparison per card here
  })
  return Object.values(cardMap)
}

// ---------------------------
// Manual sync trigger
// ---------------------------
export const syncUser = async () => {
  try {
    const localUser = await getUserData()
    if (!localUser) return

    const localCards = (await getCards()) || []
    localUser.lastUpdate = Date.now()
    await storeUserData(localUser)
    await uploadUserToBackend(localUser)
    await uploadCardsToBackend(localUser.userId, localCards)

    console.log('✅ Manual sync complete')
  } catch (err) {
    console.error('❌ Failed to sync user:', err)
  }
}
